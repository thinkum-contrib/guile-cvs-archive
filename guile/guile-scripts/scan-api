#!/bin/sh
# Usage: scan-api guile sofile
# The output is an alist: ((meta ...) (scheme ...) (C ...))

guile=$1
sofile=$2

scheme ()
{
$guile -c '(use-modules (ice-9 session)) (apropos ".")' \
    | grep ^.guile \
    | tr -s '[:blank:]' ' ' \
    | sed 's/^.*: //g' \
    | sed 's/^\([^ ]*\) *\(.*\)/(\1 "\2")/g' \
    | sort
}

C ()
{
# lowercase => locals
# A => absolute
# U => undefined
nm $sofile \
    | grep ' [A-Z] ' \
    | grep -v ' [AU] ' \
    | sed 's/^........ \(.\) \(.*\)/(\2 \1)/g' \
    | sort
}

echo ';; Generated' `date` 'by guile-scripts/scan-api -- do not edit!'
echo '('
echo '(meta (GUILE_LOAD_PATH . "'$GUILE_LOAD_PATH'")'
echo '      (LTDL_LIBRARY_PATH . "'$LTDL_LIBRARY_PATH'")'
echo '      (guile . "'$guile'")'
echo '      (sofile . "'$sofile'"))'
echo '(scheme' ; scheme ; echo ') ;; end of scheme'
echo '(C     ' ; C      ; echo ') ;; end of C'
echo ') ;; eof'

# scan-api ends here
